<!--
Copyright Â© MyScript.
LICENSE: [Apache License 2.0](http://www.apache.org/licenses/LICENSE-2.0)
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="./katex-import.html">

<dom-module id="myscript-math-exports">
    <style>
        :host {
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: larger;
            color: var(--myscript-math-exports-color, #000000);
            min-height: 95px;
        }

        [hidden] {
            display: none;
        }
    </style>
    <template>
        <div id="katex"></div>
        <div id="latex" hidden></div>
        <div id="mathml" hidden></div>
        <div id="officeopenxml" hidden></div>
    </template>
</dom-module>

<script>
    Polymer({
                is: 'myscript-math-exports',
                properties: {
                    /**
                     * Exports result.
                     * @attribute exports
                     * @type {Object<String, Object>}.
                     */
                    exports: {
                        type: Object,
                        notify: true,
                        observer: '_exportsChanged'
                    }
                },
                // Will be renamed connected with pure custom element support
                attached: function () {

                    /**
                     * Function returning the root dom element whatever shadow or shady dom is used.
                     * @param domElement
                     * @returns {*}
                     */
                    function qsWrapper(domElement) {
                        if (domElement.shadowRoot) {
                            return domElement.shadowRoot;
                        } else {
                            return domElement;
                        }
                    }
                    this.katexElement = qsWrapper(this).querySelector('#katex');
                    this.latexElement = qsWrapper(this).querySelector('#latex');
                    this.mathmlElement = qsWrapper(this).querySelector('#mathml');
                    this.officeopenxmlElement = qsWrapper(this).querySelector('#officeopenxml');
                },
                /**
                 * @private
                 */
                _exportsChanged: function (exports) {
                    this.latexElement.innerText = '';
                    this.katexElement.innerHTML = '';
                    if (exports) {

                        /**
                         * Replace latex strings with similar one compatible with katex.
                         * @param latex
                         */
                        function clean(latex) {
                            return latex
                                .replace("\\overrightarrow", "\\vec")
                                .replace("\\llbracket", "\\lbracket")
                                .replace("\\rrbracket", "\\rbracket")
                                .replace("\\widehat", "\\hat")
                                .replace(new RegExp("(align.{1})", "g"), "aligned");
                        }

                        // Updating the rendering zone displayed with KaTex (taking the latex export as an input)
                        var latexResult = exports['application/x-latex'] ? exports['application/x-latex'] : exports.LATEX;
                        if (latexResult) {
                          this.latexElement.innerText = latexResult;
                            try {
                                katex.render(clean(latexResult), this.katexElement);
                            } catch (e) {
                                this.katexElement.innerHTML = '<span>' + clean(latexResult) + '</span>';
                            }
                        }
                        var mathmlResult = exports['application/mathml+xml'] ? exports['application/mathml+xml'] : exports.MATHML;
                        if (mathmlResult) {
                          this.mathmlElement.innerText = mathmlResult;
                        }
                    }
                }
            }
    );
</script>
